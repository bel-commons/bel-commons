{% extends "base.html" %}

{% import "bootstrap/wtf.html" as wtf %}
{% import "bootstrap/fixes.html" as fixes %}
{% import "bootstrap/utils.html" as util %}

{% block styles %}
    {{ super() }}
    <link href="{{ url_for('static', filename='css/c3.min.css') }}" rel="stylesheet" type="text/css"/>
{% endblock %}

{% block head %}
    {{ super() }}

    <script src="{{ url_for('static', filename='js/d3.3.5.17.min.js') }}" charset="utf-8"></script>
    <script src="{{ url_for('static', filename='js/c3.min.js') }}"></script>
    <script src="//code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.13/js/dataTables.bootstrap.min.js"></script>
    <script>
        // Initializes popover
        $(function () {
            $('[data-toggle="popover"]').popover({
                placement: 'top',
                trigger: 'hover'
            })
        })
    </script>
{% endblock %}

{% block title %}Statistics{% endblock %}

{% block content %}
    <a id="top"></a>
    <div class="container">
        <div class="page-header">
            <h1>Statistics over {{ network.name }}
                <small class="text-muted">{{ network.version }}</small>
            </h1>
        </div>

        {{ util.flashed_messages(dismissible=True, container=False) }}

        <div class="panel panel-default">
            <div class="panel-body">
                <a class="btn btn-primary" href="{{ url_for('view_networks') }}" role="button">List Networks</a>

                {% if network.report and network.report.is_displayable %}
                    <a href="{{ url_for('view_explore_network', network_id=network.id) }}"
                       class="btn btn-default" data-toggle="popover"
                       title="Explore this Network"
                       data-content="Visualize this Network in the Biological Network Explorer.
                                   Note that if the network is larger than 100 nodes, you would need to filter the
                                   network before rendering it in order to avoid crash your browser.">
                        <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                        Explore
                    </a>
                {% else %}
                    <button class="btn btn-default" data-toggle="popover"
                            title="Explore this Network" disabled
                            data-content="This network is too large to explore directly, so build a query first.">
                        <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                        Explore
                    </button>
                {% endif %}

                <a href="{{ url_for('view_query_builder', start=network.id) }}"
                   class="btn btn-default" data-toggle="popover"
                   title="Perform a Query on this Network"
                   data-content="You can ask specific questions to your network using the
                                       Query Builder.">
                    <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                    Query
                </a>
                <a href="{{ url_for('analysis.view_network_analysis_uploader', network_id=network.id) }}"
                   class="btn btn-default" data-toggle="popover"
                   title="Analyze this Network"
                   data-content="Upload your experiments and run algorithms on your network.">
                    <span class="glyphicon glyphicon-flash" aria-hidden="true"></span>
                    Analyze
                </a>
                <a class="btn btn-default" href="{{ url_for('analysis.view_analyses', network_id=network_id) }}"
                   role="button">
                    <span class="glyphicon glyphicon-tasks" aria-hidden="true"></span>
                    Results
                </a>

                {% if current_user.is_authenticated %}
                    <a class="btn btn-default" role="button"
                       href="{{ url_for('dbs.export_network', network_id=network_id, serve_format='bel') }}">
                        <span class="glyphicon glyphicon-download" aria-hidden="true"></span> BEL Script</a>
                    <a class="btn btn-default" role="button"
                       href="{{ url_for('dbs.export_network', network_id=network_id, serve_format='json') }}">
                        <span class="glyphicon glyphicon-download" aria-hidden="true"></span> Node-Link JSON</a>
                    <a class="btn btn-default" role="button"
                       href="{{ url_for('dbs.export_network', network_id=network_id, serve_format='cx') }}">
                        <span class="glyphicon glyphicon-download" aria-hidden="true"></span> CX JSON</a>
                {% endif %}

                {% if current_user.is_admin %}
                    <a class="btn btn-danger" role="button"
                       href="{{ url_for('dbs.drop_network', network_id=network_id, next=url_for('home')) }}">
                        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                        Drop
                    </a>
                {% endif %}
            </div>
        </div>

        {% if network_versions is defined and network_versions|length > 1 %}
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Versions
                        <span class="badge">{{ network_versions|length }}</span>
                        <a class="pull-right" href="#top">
                            <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>
                        </a>
                    </h3>
                </div>
                <div class="panel-body">
                    <ul class="list-inline">
                        {% for network_version in network_versions %}
                            {% if network_version.id == network_id %}
                                <li>
                                    <a class="btn btn-info" role="button"
                                       href="{{ url_for('view_summarize_statistics', network_id=network_version.id) }}">{{ network_version.version }}</a>
                                </li>
                            {% else %}
                                <li>
                                    <a class="btn btn-default" role="button"
                                       href="{{ url_for('view_summarize_statistics', network_id=network_version.id) }}">{{ network_version.version }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
        {% endif %}

        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Table of Contents</h3>
            </div>
            <div class="panel-body">
                <ol>
                    <li><a href="#provenance">Provenance</a></li>
                    <li><a href="#network-statistics">Network Statistics</a></li>
                    <li><a href="#content-statistics">Content Statistics</a></li>
                    <li><a href="#overlap">Network Overlap</a></li>

                </ol>
            </div>
        </div>

        <a id="provenance"></a>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Provenance
                    <a class="pull-right" href="#top">
                        <span class="glyphicon glyphicon-arrow-up"></span>
                    </a>
                </h3>
            </div>
            <div class="panel-body">
                <dl class="dl-horizontal">
                    {% if network.report %}
                        <dt>Upload</dt>
                        <dd>{{ network.report.user.email }} at {{ network.report.created }}</dd>
                    {% endif %}

                    <dt>Authors</dt>
                    <dd>{{ network.authors }}</dd>

                    <dt>Contact</dt>
                    <dd>{{ network.contact }}</dd>

                    {% if network.description %}
                        <dt>Description</dt>

                        <dd>{{ network.description }}</dd>
                    {% endif %}

                    <dt>License</dt>
                    <dd>{{ network.licenses }}</dd>

                    <dt>Copyright</dt>
                    <dd>{{ network.copyright }}</dd>
                </dl>
            </div>
        </div>

        <a id="network-statistics"></a>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Network Statistics
                    <a class="pull-right" href="#top">
                        <span class="glyphicon glyphicon-arrow-up"></span>
                    </a>
                </h3>
            </div>
            <div class="panel-body">
                <dl class="dl-horizontal">
                    <dt>Number Nodes</dt>
                    <dd>{{ network.report.number_nodes }}</dd>
                    <dt>Number Edges</dt>
                    <dd>{{ network.report.number_edges }}</dd>
                    <dt>Number Components</dt>
                    <dd>{{ network.report.number_components }}</dd>
                    <dt>Network Density</dt>
                    <dd>{{ network.report.network_density }}</dd>
                    <dt>Average Degree</dt>
                    <dd>{{ network.report.average_degree }}</dd>
                    <dt>Number Citations</dt>
                    <dd>{{ network.report.number_citations }}</dd>
                    <dt>Number Authors</dt>
                    <dd>{{ network.report.number_authors }}</dd>
                    <dt>Number BEL Errors</dt>
                    <dd>{{ network.report.number_warnings }}</dd>
                </dl>
            </div>
        </div>

        <a id="content-statistics"></a>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Content Statistics
                    <a class="pull-right" href="#top">
                        <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>
                    </a>
                </h3>
            </div>
            <div class="panel-body">
                <div class="row">
                    {% if chart_3_data %}
                        <div class="col-md-4">
                            <div id="chart3"></div>
                        </div>
                    {% endif %}
                    <div class="col-md-4">
                        <div id="chart1"></div>
                    </div>
                    <div class="col-md-4">
                        <div id="chart2"></div>
                    </div>
                    {% if chart_4_data %}
                        <div class="col-md-4">
                            <div id="chart4"></div>
                        </div>
                    {% endif %}
                    {% if chart_5_data %}
                        <div class="col-md-4">
                        <div id="chart5"></div>
                    {% endif %}
                    </div>
                    <div class="col-md-4">
                        <div id="chart6"></div>
                    </div>
                    <div class="col-md-4">
                        <div id="chart7"></div>
                    </div>
                    {% if chart_9_data %}
                        <div class="col-md-4">
                            <div id="chart9"></div>
                        </div>
                    {% endif %}
                    <div class="col-md-4">
                        <div id="chart10"></div>
                    </div>
                    <div class="col-md-4">
                        <div id="chart11"></div>
                    </div>
                    <div class="col-md-4">
                        <div id="chart12"></div>
                    </div>
                </div>
            </div>
        </div>

        <a id="overlap"></a>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Network Overlap
                    <a class="pull-right" href="#top">
                        <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>
                    </a>
                </h3>
            </div>
            <div class="panel-body">
                <p>
                    The overlap between networks is calculated by the overlap of their contained nodes. The top 10 are
                    shown below.
                </p>
            </div>
            <table class="table table-hover table-responsive table-striped">
                <thead>
                <tr>
                    <th>Network</th>
                    <th>Node Overlap</th>
                </tr>
                </thead>
                <tbody>
                {% for other_network, tanimoto in overlaps %}
                    {% if other_network %}
                        <tr>
                            <td>
                                <a href="{{ url_for('view_summarize_statistics', network_id=other_network.id) }}">{{ other_network }}</a>
                            </td>
                            <td>{{ (100 * tanimoto)|round|int }}%</td>
                        </tr>
                    {% endif %}
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% include "footer.html" %}
{% endblock %}

{% block scripts %}
    {{ super() }}

    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>

    <script>
        var chart1 = c3.generate({
            padding: {
                top: 15,
                left: 100
            },
            size: {
                height: 350
            },
            bindto: '#chart1',
            data: {
                x: 'x',
                columns: {{ chart_1_data|safe}},
                type: 'bar'
            },
            title: {
                text: 'Node Types'
            },
            axis: {
                rotated: true,
                x: {
                    type: 'category'
                }
            },
            legend: {
                show: false
            }
        });

        var chart2 = c3.generate({
            padding: {
                top: 15,
                left: 100
            },
            size: {
                height: 350
            },
            bindto: '#chart2',
            data: {
                x: 'x',
                columns: {{ chart_2_data|safe}},
                type: 'bar'
            },
            title: {
                text: 'Relation Types'
            },
            axis: {
                rotated: true,
                x: {
                    type: 'category'
                }
            },
            legend: {
                show: false
            }
        });

        {% if chart_3_data %}
            var chart3 = c3.generate({
                padding: {
                    top: 15,
                    left: 100
                },
                size: {
                    height: 350
                },
                bindto: '#chart3',
                data: {
                    x: 'x',
                    columns: {{ chart_3_data|safe}},
                    type: 'bar'
                },
                title: {
                    text: 'Warning Types'
                },
                axis: {
                    rotated: true,
                    x: {
                        type: 'category'
                    }
                },
                legend: {
                    show: false
                }
            });
        {% endif %}

        {% if chart_4_data %}
            var chart4 = c3.generate({
                padding: {
                    top: 15,
                    left: 100
                },
                size: {
                    height: 350
                },
                bindto: '#chart4',
                data: {
                    x: 'x',
                    columns: {{ chart_4_data|safe}},
                    type: 'bar'
                },
                title: {
                    text: 'Node Transformations'
                },
                axis: {
                    rotated: true,
                    x: {
                        type: 'category'
                    }
                },
                legend: {
                    show: false
                }
            });
        {% endif %}

        {% if chart_5_data %}
            var chart5 = c3.generate({
                padding: {
                    top: 15,
                    left: 100
                },
                size: {
                    height: 350
                },
                bindto: '#chart5',
                data: {
                    x: 'x',
                    columns: {{ chart_5_data|safe}},
                    type: 'bar'
                },
                title: {
                    text: 'Node Modifications'
                },
                axis: {
                    rotated: true,
                    x: {
                        type: 'category'
                    }
                },
                legend: {
                    show: false
                }
            });
        {% endif %}

        var chart6 = c3.generate({
            padding: {
                top: 15,
                left: 100
            },
            size: {
                height: 350
            },
            bindto: '#chart6',
            data: {
                x: 'x',
                columns: {{ chart_6_data|safe}},
                type: 'bar'
            },
            title: {
                text: 'Namespace Usage'
            },
            axis: {
                rotated: true,
                x: {
                    type: 'category'
                }
            },
            legend: {
                show: false
            }
        });

        var chart7 = c3.generate({
            padding: {
                top: 15,
                left: 100
            },
            size: {
                height: 350
            },
            bindto: '#chart7',
            data: {
                x: 'x',
                columns: {{ chart_7_data|safe}},
                type: 'bar'
            },
            title: {
                text: 'Node Degrees'
            },
            axis: {
                rotated: true,
                x: {
                    type: 'category'
                }
            },
            legend: {
                show: false
            }
        });

        {% if chart_9_data %}
            var chart9 = c3.generate({
                padding: {
                    top: 15,
                    left: 100
                },
                size: {
                    height: 350
                },
                bindto: '#chart9',
                data: {
                    x: 'x',
                    columns: {{ chart_9_data|safe}},
                    type: 'bar'
                },
                title: {
                    text: 'Pathologies'
                },
                axis: {
                    rotated: true,
                    x: {
                        type: 'category'
                    }
                },
                legend: {
                    show: false
                }
            });
        {% endif %}

        {% if chart_10_data %}

            var chart10 = c3.generate({
                padding: {
                    top: 15
                },
                size: {
                    height: 350
                },
                data: {
                    x: 'x',
                    columns: {{ chart_10_data|safe}}
                },

                bindto: '#chart10',
                axis: {
                    x: {
                        type: 'timeseries',
                        tick: {
                            format: '%Y'
                        }
                    }
                }
                , title: {
                    text: 'Publication Years'
                },
                legend: {
                    show: false
                }
            });
        {% endif %}

    </script>
{% endblock %}
